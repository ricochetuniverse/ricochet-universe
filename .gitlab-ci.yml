stages:
    - build
    - test
    - test_php

.setup_php: &setup_php
    image: php:7.2.26-alpine3.10
    cache:
        paths:
            - vendor/
    artifacts:
        paths:
            - vendor/
    services:
        - mariadb:10.4.11

    variables:
        # from .env.testing, needs to be here as .env isn't copied yet
        MYSQL_DATABASE: ricochetlevels_test
        MYSQL_USER: ricochetlevels_test
        MYSQL_PASSWORD: '123'
        MYSQL_RANDOM_ROOT_PASSWORD: 'yes'
    before_script:
        - apk update && apk upgrade
        - apk add --no-cache git
        - docker-php-ext-install pdo_mysql

        - curl https://getcomposer.org/installer | php -- --install-dir=/usr/local/bin --filename=composer
        - composer install --no-progress

        - cp .env.testing .env
        - php artisan key:generate
        - php artisan migrate

.setup_node: &setup_node
    image: node:12
    cache:
        paths:
            - node_modules/
    artifacts:
        paths:
            - node_modules/
            - public/build/
            - public/mix-manifest.json

yarn:
    stage: build
    <<: *setup_node
    script:
        - yarn

eslint:
    stage: test
    <<: *setup_node
    script:
        - yarn run lint
    dependencies:
        - yarn

prettier:
    stage: test
    <<: *setup_node
    script:
        - yarn run prettier -l
    dependencies:
        - yarn

webpack:
    stage: test
    <<: *setup_node
    script:
        - yarn production
    dependencies:
        - yarn

phpunit:
    stage: test_php
    <<: *setup_php
    script:
        - composer test
    dependencies:
        - webpack
    needs:
        - webpack
